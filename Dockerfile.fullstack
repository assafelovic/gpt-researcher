########################################################################
# Stage 1: Frontend build
########################################################################
FROM node:slim AS frontend-builder
WORKDIR /app/frontend/nextjs

# Copy package files and install dependencies
COPY frontend/nextjs/package.json frontend/nextjs/package-lock.json* ./
RUN npm install --legacy-peer-deps

# Copy the rest of the frontend application and build it
COPY frontend/nextjs/ ./
RUN npm run build

########################################################################
# Stage 2: Browser and backend build tools installation
########################################################################
FROM python:3.13.3-slim-bookworm AS install-browser

# Install Chromium, Chromedriver, Firefox, Geckodriver, nginx, and build tools in one layer
RUN echo 'Acquire::Retries "3";' > /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::http::Timeout "60";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::https::Timeout "60";' >> /etc/apt/apt.conf.d/80-retries \
  && echo 'Acquire::ftp::Timeout "60";' >> /etc/apt/apt.conf.d/80-retries \
  && apt-get update \
  && apt-get install -y gnupg wget ca-certificates nginx --no-install-recommends \
  && ARCH=$(dpkg --print-architecture) \
  && if [ "$ARCH" = "arm64" ]; then \
  apt-get install -y chromium chromium-driver \
  && chromium --version && chromedriver --version; \
  else \
  wget -qO - https://dl.google.com/linux/linux_signing_key.pub | apt-key add - \
  && echo "deb [arch=${ARCH}] http://dl.google.com/linux/chrome/deb/ stable main" \
  > /etc/apt/sources.list.d/google-chrome.list \
  && apt-get update \
  && apt-get install -y google-chrome-stable; \
  fi \
  && apt-get install -y --no-install-recommends firefox-esr build-essential \
  && GECKO_ARCH=$(case ${ARCH} in amd64) echo "linux64" ;; arm64) echo "linux-aarch64" ;; *) echo "linux64" ;; esac) \
  && wget https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-${GECKO_ARCH}.tar.gz \
  && tar -xvzf geckodriver-v0.36.0-${GECKO_ARCH}.tar.gz \
  && chmod +x geckodriver \
  && mv geckodriver /usr/local/bin/ \
  && rm geckodriver-v0.36.0-${GECKO_ARCH}.tar.gz \
  && rm -rf /var/lib/apt/lists/*

########################################################################
# Stage 3: Python dependencies installation
########################################################################
FROM install-browser AS backend-builder
WORKDIR /usr/src/app

ENV PIP_ROOT_USER_ACTION=ignore

COPY ./requirements.txt ./requirements.txt
COPY ./multi_agents/requirements.txt ./multi_agents/requirements.txt

# Install Python packages with retry logic and timeout configuration
RUN pip config set global.timeout 60 && \
  pip config set global.retries 3 && \
  pip install --upgrade pip && \
  pip install --no-cache-dir -r requirements.txt --upgrade --prefer-binary && \
  pip install --no-cache-dir -r multi_agents/requirements.txt --upgrade --prefer-binary

########################################################################
# Stage 4: Final image with backend, frontend, and nginx
########################################################################
FROM backend-builder AS final

WORKDIR /usr/src/app

# Install Node.js and supervisord with retry logic
RUN apt-get update && \
  apt-get install -y curl supervisor && \
  curl -fsSL --retry 3 --retry-delay 10 https://deb.nodesource.com/setup_20.x | bash - && \
  apt-get install -y nodejs && \
  rm -rf /var/lib/apt/lists/*

# Set backend server configuration
ARG HOST=0.0.0.0
ENV HOST=${HOST}

ARG PORT=8000
ENV PORT=${PORT}

ARG NEXT_PORT=3000
ENV NEXT_PORT=${NEXT_PORT}

# Nginx will serve on port 80 by default, but make it configurable
ARG NGINX_PORT=80
ENV NGINX_PORT=${NGINX_PORT}
EXPOSE ${NGINX_PORT}

# Copy application files
COPY ./ ./

# Copy built frontend from the frontend-builder stage
COPY --from=frontend-builder /app/frontend/nextjs/.next ./frontend/nextjs/.next
COPY --from=frontend-builder /app/frontend/nextjs/node_modules ./frontend/nextjs/node_modules
COPY --from=frontend-builder /app/frontend/nextjs/public ./frontend/nextjs/public
COPY --from=frontend-builder /app/frontend/nextjs/package.json ./frontend/nextjs/package.json
# Ensure next.config.mjs and other necessary files are present
COPY --from=frontend-builder /app/frontend/nextjs/next.config.mjs ./frontend/nextjs/next.config.mjs

# Create nginx configuration for reverse proxy
RUN mkdir -p /etc/nginx/sites-available /etc/nginx/sites-enabled && \
  rm -f /etc/nginx/sites-enabled/default && \
  echo 'server {' > /etc/nginx/sites-available/gpt-researcher && \
  echo '    listen %(ENV_NGINX_PORT)s;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    server_name _;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    # WebSocket proxy for /ws endpoint' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    location /ws {' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_pass http://127.0.0.1:%(ENV_PORT)s/ws;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_http_version 1.1;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header Upgrade $http_upgrade;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header Connection "upgrade";' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header Host $host;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Real-IP $remote_addr;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_cache_bypass $http_upgrade;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_read_timeout 86400s;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_send_timeout 86400s;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    }' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    # API proxy for backend endpoints' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    location /api/ {' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_pass http://127.0.0.1:%(ENV_PORT)s/;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header Host $host;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Real-IP $remote_addr;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    }' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    # Serve frontend application' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    location / {' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_pass http://127.0.0.1:%(ENV_NEXT_PORT)s;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header Host $host;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Real-IP $remote_addr;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '        proxy_set_header X-Forwarded-Proto $scheme;' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '    }' >> /etc/nginx/sites-available/gpt-researcher && \
  echo '}' >> /etc/nginx/sites-available/gpt-researcher

# Create supervisord configuration
# stdout/stderr_maxbytes prevents log file rotation and ensures continuous output
RUN echo '[supervisord]' > /etc/supervisor/conf.d/supervisord.conf && \
  echo 'nodaemon=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'user=root' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'logfile=/dev/stdout' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '[program:backend]' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'command=uvicorn main:app --host 127.0.0.1 --port %(ENV_PORT)s' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'directory=/usr/src/app' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autostart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '[program:frontend]' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'command=npm run start -- -p %(ENV_NEXT_PORT)s' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'directory=/usr/src/app/frontend/nextjs' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autostart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo '[program:nginx]' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'command=sh -c "envsubst < /etc/nginx/sites-available/gpt-researcher > /etc/nginx/sites-enabled/gpt-researcher && nginx -g \"daemon off;\""' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autostart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'autorestart=true' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor/conf.d/supervisord.conf && \
  echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor/conf.d/supervisord.conf

# Start supervisord to manage all three services
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf"]
